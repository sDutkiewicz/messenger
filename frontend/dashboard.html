<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <header>
            <h2>Wiadomości</h2>
            <div id="userHeader">
                Zalogowany jako: <strong id="meName">—</strong>
                <button id="logoutBtn">Wyloguj</button>
            </div>
        </header>
        <div class="dashboard-container">
            <div id="usersList">
                <h3>Użytkownicy</h3>
                <ul id="users"></ul>
            </div>
            <div id="conversation">
            <h3 id="convTitle">Wybierz użytkownika</h3>
            <div id="messages"></div>
            <form id="sendForm" enctype="multipart/form-data">
                <input type="text" id="msgInput" placeholder="Napisz wiadomość..." required>
                <input type="file" id="fileInput" name="attachments" multiple>
                <div id="attachmentsList"></div>
                <button type="submit">Wyślij</button>
            </form>
        </div>
        </div>
    </div>
    <script>
    let selectedUser = null;
    let myId = null;

    async function fetchMyId() {
        const res = await fetch('/api/me', { credentials: 'same-origin' });
        const data = await res.json();
        myId = data.id;
        const nameEl = document.getElementById('meName');
        if (data && data.username) nameEl.textContent = data.username; else nameEl.textContent = '—';
    }

    document.getElementById('logoutBtn').onclick = async function() {
        await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
        localStorage.removeItem('loggedIn');
        window.location.href = 'login.html';
    };

    async function fetchUsers() {
        const res = await fetch('/api/users');
        const users = await res.json();
        const ul = document.getElementById('users');
        ul.innerHTML = '';
        users.forEach(u => {
            const li = document.createElement('li');
            li.textContent = u.username;
            li.dataset.id = u.id;
            li.onclick = () => selectUser(u);
            if (selectedUser && selectedUser.id === u.id) li.classList.add('selected');
            ul.appendChild(li);
        });
    }

    async function fetchMessages(userId) {
        const res = await fetch(`/api/messages/conversation/${userId}`);
        if (!res.ok) return;
        const data = await res.json();
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        data.messages.forEach(m => {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-item';
            const who = (m.sender_id === myId) ? 'Ty' : m.sender;
            const textNode = document.createElement('span');
            let text = `${who}: ${m.content}`;
            if (m.sender_id === myId) {
                text += m.is_read ? ' ✓ Odczytane' : ' ☐ Wysłane';
            }
            textNode.textContent = text;
            wrapper.appendChild(textNode);

            if (m.attachments && m.attachments.length) {
                const attList = document.createElement('div');
                attList.style.marginTop = '6px';
                m.attachments.forEach(a => {
                    const aLink = document.createElement('a');
                    aLink.href = `/api/attachments/${a.id}`;
                    aLink.textContent = a.filename;
                    aLink.target = '_blank';
                    aLink.style.display = 'inline-block';
                    aLink.style.marginRight = '8px';
                    attList.appendChild(aLink);
                });
                wrapper.appendChild(attList);
            }

            if (m.sender_id === myId) {
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Usuń';
                delBtn.className = 'delete-btn';
                delBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (!confirm('Na pewno usunąć wiadomość?')) return;
                    const res = await fetch(`/api/messages/${m.id}`, { method: 'DELETE' });
                    if (res.status === 204) {
                        fetchMessages(selectedUser.id);
                    } else {
                        const err = await res.json();
                        alert(err.error || 'Błąd usuwania');
                    }
                };
                wrapper.appendChild(delBtn);
            }

            messagesDiv.appendChild(wrapper);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    let pollIntervalId = null;
    let usersIntervalId = null;

    function startUsersPolling(){
        if (usersIntervalId) return;
        usersIntervalId = setInterval(fetchUsers, 10000);
    }

    function stopUsersPolling(){
        if (!usersIntervalId) return;
        clearInterval(usersIntervalId);
        usersIntervalId = null;
    }

    function startConversationPolling(userId){
        if (pollIntervalId) clearInterval(pollIntervalId);
        pollIntervalId = setInterval(()=>{
            if (selectedUser) fetchMessages(selectedUser.id);
        }, 2000);
    }

    function stopConversationPolling(){
        if (pollIntervalId) clearInterval(pollIntervalId);
        pollIntervalId = null;
    }

    function selectUser(user) {
        selectedUser = user;
        document.getElementById('convTitle').textContent = 'Rozmowa z: ' + user.username;
        document.getElementById('sendForm').style.display = 'flex';
        document.querySelectorAll('#users li').forEach(li => li.classList.remove('selected'));
        const node = Array.from(document.querySelectorAll('#users li')).find(n => n.dataset.id == user.id);
        if (node) node.classList.add('selected');
        fetchMessages(user.id);
        startConversationPolling(user.id);
    }

    function updateAttachmentsList() {
        const fileInput = document.getElementById('fileInput');
        const attachmentsList = document.getElementById('attachmentsList');
        attachmentsList.innerHTML = '';
        if (!fileInput.files.length) return;
        const listDiv = document.createElement('div');
        listDiv.style.marginTop = '8px';
        listDiv.style.padding = '8px';
        listDiv.style.backgroundColor = '#f0f0f0';
        listDiv.style.borderRadius = '4px';
        const title = document.createElement('strong');
        title.textContent = 'Załączniki (' + fileInput.files.length + '):';
        listDiv.appendChild(title);
        const fileList = document.createElement('div');
        fileList.style.marginTop = '6px';
        Array.from(fileInput.files).forEach((file, index) => {
            const fileItemDiv = document.createElement('div');
            fileItemDiv.style.display = 'flex';
            fileItemDiv.style.justifyContent = 'space-between';
            fileItemDiv.style.alignItems = 'center';
            fileItemDiv.style.padding = '4px';
            fileItemDiv.style.borderBottom = '1px solid #ddd';
            const nameSpan = document.createElement('span');
            nameSpan.textContent = file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)';
            fileItemDiv.appendChild(nameSpan);
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '✕';
            removeBtn.style.padding = '2px 8px';
            removeBtn.style.backgroundColor = '#ff6b6b';
            removeBtn.style.color = 'white';
            removeBtn.style.border = 'none';
            removeBtn.style.borderRadius = '3px';
            removeBtn.style.cursor = 'pointer';
            removeBtn.onclick = (e) => {
                e.preventDefault();
                const dt = new DataTransfer();
                Array.from(fileInput.files).forEach((f, i) => {
                    if (i !== index) dt.items.add(f);
                });
                fileInput.files = dt.files;
                updateAttachmentsList();
            };
            fileItemDiv.appendChild(removeBtn);
            fileList.appendChild(fileItemDiv);
        });
        listDiv.appendChild(fileList);
        attachmentsList.appendChild(listDiv);
    }

    document.getElementById('fileInput').onchange = updateAttachmentsList;

    document.getElementById('sendForm').onsubmit = async function(e) {
        e.preventDefault();
        if (!selectedUser) return;
        const msg = document.getElementById('msgInput').value;
        const fileInput = document.getElementById('fileInput');
        const form = new FormData();
        form.append('recipient_id', selectedUser.id);
        form.append('content', msg);
        if (fileInput && fileInput.files.length) {
            for (let i = 0; i < fileInput.files.length; i++) {
                form.append('attachments', fileInput.files[i]);
            }
        }
        try {
            const response = await fetch('/api/messages/send', {
                method: 'POST',
                body: form,
                credentials: 'same-origin'
            });
            const data = await response.json();
            if (!response.ok) {
                alert('Błąd wysyłania: ' + (data.error || 'Nieznany błąd'));
                return;
            }
            document.getElementById('msgInput').value = '';
            if (fileInput) fileInput.value = '';
            document.getElementById('attachmentsList').innerHTML = '';
            fetchMessages(selectedUser.id);
        } catch (error) {
            alert('Błąd wysyłania: ' + error.message);
        }
    };

    (async ()=>{
        await fetchMyId();
        await fetchUsers();
        startUsersPolling();
    })();
    </script>
</body>
</html>
