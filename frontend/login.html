<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logowanie - Messenger</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <a href="index.html" style="display: inline-block; margin-bottom: 15px; padding: 8px 12px; background-color: #2196F3; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">← Wróć do strony głównej</a>
        <h2>Logowanie</h2>
        <form id="loginForm">
            <input type="text" name="username" placeholder="Nazwa użytkownika lub email" required>
            <input type="password" name="password" placeholder="Hasło" required>
            <button type="submit">Zaloguj się</button>
        </form>
        <div id="loginMsg"></div>
        <a href="#" id="forgotPasswordLink" style="font-size: 16px; color: #28a745; font-weight: bold;">Zapomniałem hasła</a>
        <div id="twofaSection">
            <h3>Weryfikacja 2FA</h3>
            <form id="login2faForm">
                <input type="text" name="code" placeholder="000000" required pattern="\d{6}" inputmode="numeric" style="font-size: 20px; letter-spacing: 5px; text-align: center;">
                <button type="submit">Weryfikuj kod</button>
                <button type="button" id="lostAccessBtn" style="background-color: #ff9800; margin-top: 10px;">Straciłem dostęp do 2FA</button>
            </form>
            <div id="login2faMsg"></div>
            
            <!-- Recovery code section (hidden by default) -->
            <div id="recoveryCodeSection" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                <h4>Użyj kodu odzyskiwania</h4>
                <p>Jeśli utraciłeś dostęp do aplikacji 2FA, możesz użyć kodu odzyskiwania.</p>
                <p style="font-size: 12px; color: #666;">Format: <strong>XXXX-XXXX-XXXX</strong> (np. A1B2-C3D4-E5F6)</p>
                <form id="recoveryCodeForm">
                    <input type="email" name="email" placeholder="Email" required>
                    <input type="text" name="recovery_code" placeholder="Kod odzyskiwania (XXXX-XXXX-XXXX)" required>
                    <button type="submit">Weryfikuj kod odzyskiwania</button>
                    <button type="button" id="backTo2faBtn" style="background-color: #999; margin-left: 10px;">Wróć do 2FA</button>
                </form>
                <div id="recoveryCodeMsg"></div>
            </div>
        </div>
        <a href="register.html" style="font-size: 16px; color: #28a745; font-weight: bold;">Nie masz konta? Zarejestruj się</a>
        
        <!-- Password Reset Section (hidden by default) -->
        <div id="passwordResetSection" style="display: none; margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
            <h3>Resetowanie hasła</h3>
            
            <!-- Step 1: Enter email -->
            <div id="resetStep1" style="display: block;">
                <h4>Krok 1: Potwierdź email</h4>
                <form id="forgotPasswordForm">
                    <input type="email" name="email" placeholder="Twój email" required>
                    <button type="submit">Dalej</button>
                    <button type="button" id="cancelResetBtn" style="background-color: #999; margin-left: 10px;">Anuluj</button>
                </form>
                <div id="resetStep1Msg"></div>
            </div>
            
            <!-- Step 2: Enter recovery code -->
            <div id="resetStep2" style="display: none;">
                <h4>Krok 2: Wpisz kod odzyskiwania</h4>
                <form id="verifyRecoveryForm">
                    <input type="text" name="recovery_code" placeholder="Kod odzyskiwania (XXXX-XXXX-XXXX)" required>
                    <button type="submit">Weryfikuj kod</button>
                    <button type="button" id="backToEmailBtn" style="background-color: #999; margin-left: 10px;">Wróć</button>
                </form>
                <div id="resetStep2Msg"></div>
            </div>
            
            <!-- Step 3: Set new password -->
            <div id="resetStep3" style="display: none;">
                <h4>Krok 3: Ustaw nowe hasło</h4>
                <form id="setNewPasswordForm">
                    <input type="password" name="new_password" placeholder="Nowe hasło" required minlength="12">
                    <input type="password" name="confirm_password" placeholder="Potwierdź hasło" required minlength="12">
                    <button type="submit">Zmień hasło</button>
                </form>
                <div id="resetStep3Msg"></div>
            </div>
        </div>
    </div>
    <script>
    function showMessage(elementId, text, color) {
        const el = document.getElementById(elementId);
        el.textContent = text;
        el.style.color = color;
    }
    
    // Simple sanitizer to remove potentially dangerous characters
    function sanitizeInput(value) {
        if (!value) return value;
        // Remove script tags and HTML entities that could cause SQL injection
        return String(value)
            .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
            .replace(/['"`;]/g, (char) => {
                // Escape quotes and backticks
                if (char === "'") return "''";
                if (char === '"') return '""';
                return char;
            })
            .trim();
    }
    
    // Check for active login block on page load
    async function checkLoginBlockStatus() {
        const usernameInput = document.querySelector('input[name="username"]');
        const username = sanitizeInput(usernameInput?.value);
        
        if (!username) return;
        
        try {
            const res = await fetch('/api/check-login-block', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: username})
            });
            const data = await res.json();
            
            if (data.blocked && data.remaining > 0) {
                const form = document.getElementById('loginForm');
                form.querySelector('button').disabled = true;
                showMessage('loginMsg', data.message, 'red');
                
                // Start countdown
                let remaining = data.remaining;
                form.querySelector('button').textContent = `Czekaj ${remaining}s...`;
                
                const countdownInterval = setInterval(() => {
                    remaining--;
                    if (remaining <= 0) {
                        clearInterval(countdownInterval);
                        form.querySelector('button').disabled = false;
                        form.querySelector('button').textContent = 'Zaloguj się';
                        showMessage('loginMsg', '', 'black');
                    } else {
                        form.querySelector('button').textContent = `Czekaj ${remaining}s...`;
                    }
                }, 1000);
            }
        } catch (error) {
            console.error('Error checking login block:', error);
        }
    }
    
    // Check block status when username input loses focus
    document.addEventListener('DOMContentLoaded', () => {
        const usernameInput = document.querySelector('input[name="username"]');
        if (usernameInput) {
            usernameInput.addEventListener('blur', checkLoginBlockStatus);
        }
    });
    
    async function fetchAndStorePrivateKey(password) {
        try {
            const res = await fetch('/api/get-private-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password }),
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (res.ok) {
                sessionStorage.setItem('privateKeyDecrypted', data.private_key);
                return true;
            } else {
                return false;
            }
        } catch (error) {
            return false;
        }
    }

    document.getElementById('loginForm').onsubmit = async function(e) {
        e.preventDefault();
        const form = e.target;
        const password = form.password.value;
        const data = {
            username: sanitizeInput(form.username.value),
            password: password
        };
        
        // Disable form during request
        form.querySelector('button').disabled = true;
        
        const res = await fetch('/api/login', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const body = await res.json().catch(() => ({}));
        
        if (res.ok && body['2fa_required']) {
            sessionStorage.setItem('_loginPassword', password);
            showMessage('loginMsg', 'Wymagana weryfikacja 2FA.', 'orange');
            document.getElementById('twofaSection').style.display = 'block';
            form.querySelector('button').disabled = false;
        } else if (res.ok) {
            const keyLoaded = await fetchAndStorePrivateKey(password);
            if (keyLoaded) {
                showMessage('loginMsg', 'Zalogowano!', 'green');
                localStorage.setItem('loggedIn', '1');
                setTimeout(() => { window.location.href = 'dashboard.html'; }, 500);
            } else {
                showMessage('loginMsg', 'Zalogowano ale nie udało się załadować klucza prywatnego', 'orange');
                setTimeout(() => { window.location.href = 'dashboard.html'; }, 2000);
            }
        } else if (res.status === 429) {
            // Rate limit - disable form for specified time
            const retryAfter = res.headers.get('Retry-After') || 300;
            const seconds = parseInt(retryAfter);
            showMessage('loginMsg', body.error || 'Zbyt wiele prób. Spróbuj za chwilę.', 'red');
            
            form.querySelector('button').disabled = true;
            form.querySelector('button').textContent = `Czekaj ${seconds}s...`;
            
            for (let i = seconds; i > 0; i--) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                form.querySelector('button').textContent = `Czekaj ${i - 1}s...`;
            }
            
            form.querySelector('button').disabled = false;
            form.querySelector('button').textContent = 'Zaloguj się';
        } else {
            showMessage('loginMsg', body.error || 'Błąd logowania', 'red');
            form.querySelector('button').disabled = false;
        }
    };

    document.getElementById('login2faForm').onsubmit = async function(e) {
        e.preventDefault();
        const code = sanitizeInput(e.target.code.value.trim());
        const res = await fetch('/api/verify-2fa', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({code})
        });
        
        if (res.ok) {
            const password = sessionStorage.getItem('_loginPassword');
            if (password) {
                const keyLoaded = await fetchAndStorePrivateKey(password);
                if (keyLoaded) {
                    showMessage('login2faMsg', 'Weryfikacja 2FA powiodła się. Przekierowanie...', 'green');
                    localStorage.setItem('loggedIn', '1');
                    sessionStorage.removeItem('_loginPassword');
                    setTimeout(() => { window.location.href = 'dashboard.html'; }, 600);
                } else {
                    showMessage('login2faMsg', '2FA OK ale nie udało się załadować klucza', 'orange');
                    localStorage.setItem('loggedIn', '1');
                    sessionStorage.removeItem('_loginPassword');
                    setTimeout(() => { window.location.href = 'dashboard.html'; }, 1500);
                }
            } else {
                showMessage('login2faMsg', 'Błąd: nie znaleziono hasła', 'red');
            }
        } else {
            const err = await res.json().catch(() => ({}));
            showMessage('login2faMsg', err.error || 'Błąd weryfikacji 2FA', 'red');
        }
    };

    // Recovery code button handlers
    document.getElementById('lostAccessBtn').onclick = function() {
        document.getElementById('login2faForm').style.display = 'none';
        document.getElementById('recoveryCodeSection').style.display = 'block';
        showMessage('login2faMsg', '');
    };

    document.getElementById('backTo2faBtn').onclick = function() {
        document.getElementById('login2faForm').style.display = 'block';
        document.getElementById('recoveryCodeSection').style.display = 'none';
        document.getElementById('recoveryCodeForm').reset();
        showMessage('recoveryCodeMsg', '');
    };

    document.getElementById('recoveryCodeForm').onsubmit = async function(e) {
        e.preventDefault();
        const email = sanitizeInput(e.target.email.value.trim().toLowerCase());
        const recovery_code = sanitizeInput(e.target.recovery_code.value.trim());
        
        const res = await fetch('/api/auth/2fa-recovery', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email, recovery_code})
        });
        
        const data = await res.json();
        
        if (res.ok) {
            const password = sessionStorage.getItem('_loginPassword');
            if (password) {
                const keyLoaded = await fetchAndStorePrivateKey(password);
                if (keyLoaded) {
                    showMessage('recoveryCodeMsg', 'Recovery code zaakceptowany! Musisz teraz ustawić nowy 2FA...', 'green');
                    localStorage.setItem('loggedIn', '1');
                    sessionStorage.removeItem('_loginPassword');
                    // Redirect directly to forced 2FA setup page
                    setTimeout(() => { window.location.href = '2fa-setup-required.html'; }, 1000);
                } else {
                    showMessage('recoveryCodeMsg', 'Recovery OK ale nie udało się załadować klucza', 'orange');
                    localStorage.setItem('loggedIn', '1');
                    sessionStorage.removeItem('_loginPassword');
                    setTimeout(() => { window.location.href = 'dashboard.html?setup_2fa=1'; }, 1500);
                }
            } else {
                showMessage('recoveryCodeMsg', 'Błąd: nie znaleziono hasła', 'red');
            }
        } else {
            showMessage('recoveryCodeMsg', 'Email lub kod odzyskiwania jest błędny', 'red');
        }
    };
    
    // ============ PASSWORD RESET FLOW ============
    
    document.getElementById('forgotPasswordLink').onclick = function(e) {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('twofaSection').style.display = 'none';
        document.getElementById('passwordResetSection').style.display = 'block';
        showMessage('loginMsg', '');
    };
    
    document.getElementById('cancelResetBtn').onclick = function() {
        document.getElementById('passwordResetSection').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('resetStep1').style.display = 'block';
        document.getElementById('resetStep2').style.display = 'none';
        document.getElementById('resetStep3').style.display = 'none';
    };
    
    document.getElementById('backToEmailBtn').onclick = function() {
        document.getElementById('resetStep1').style.display = 'block';
        document.getElementById('resetStep2').style.display = 'none';
    };
    
    document.getElementById('forgotPasswordForm').onsubmit = async function(e) {
        e.preventDefault();
        const email = sanitizeInput(e.target.email.value.trim());
        
        const res = await fetch('/api/forgot-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email}),
            credentials: 'same-origin'
        });
        
        const data = await res.json();
        
        if (res.ok) {
            showMessage('resetStep1Msg', data.message, 'green');
            setTimeout(() => {
                document.getElementById('resetStep1').style.display = 'none';
                document.getElementById('resetStep2').style.display = 'block';
            }, 1000);
        } else {
            showMessage('resetStep1Msg', data.error || 'Błąd', 'red');
        }
    };
    
    document.getElementById('verifyRecoveryForm').onsubmit = async function(e) {
        e.preventDefault();
        const recovery_code = sanitizeInput(e.target.recovery_code.value.trim());
        
        const res = await fetch('/api/verify-recovery-for-password-reset', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recovery_code}),
            credentials: 'same-origin'
        });
        
        const data = await res.json();
        
        if (res.ok) {
            showMessage('resetStep2Msg', data.message, 'green');
            setTimeout(() => {
                document.getElementById('resetStep2').style.display = 'none';
                document.getElementById('resetStep3').style.display = 'block';
            }, 1000);
        } else {
            showMessage('resetStep2Msg', data.error || 'Błąd', 'red');
        }
    };
    
    document.getElementById('setNewPasswordForm').onsubmit = async function(e) {
        e.preventDefault();
        const new_password = e.target.new_password.value;
        const confirm_password = e.target.confirm_password.value;
        
        if (new_password !== confirm_password) {
            showMessage('resetStep3Msg', 'Hasła się nie zgadzają', 'red');
            return;
        }
        
        const res = await fetch('/api/reset-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_password, confirm_password}),
            credentials: 'same-origin'
        });
        
        const data = await res.json();
        
        if (res.ok) {
            showMessage('resetStep3Msg', data.message + ' Przekierowanie na stronę logowania...', 'green');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
        } else {
            showMessage('resetStep3Msg', data.error || 'Błąd', 'red');
        }
    };
    </script>
</body>
</html>
